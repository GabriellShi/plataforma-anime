<%- include("./partials/head") %>
<%- include("./partials/header") %>

<% if(locals.episodio){ %>

  <div class="titulo-principal-episodio-selecionado">
    <h2><%= episodio.nome %> - Episodio <%= episodio.numero_episodio %></h2>
</div>


<section class="site-animes-pedidos-de-animes site-animes-episodio-selecionado ">

    
  <div class="lado-esquerdo-do-site-pagina-anime">
       
        <a href="<%= episodio.video_url %>">
          <div class="capa-episodio-selecionado">
            <!-- <button class="botao-para-episodio"><h2>ABRIR O PLAYER</h2></button> -->

            <img src="/img/capa-para-o-episodio.jpg" alt="">
          </div>
        </a>

    <section class="sessao-1-lado-direiro-index sessao-1-lado-direiro-index-anime-mobile">
      <div class="animes-populares-index">
          <h2>Preview dos Episodios</h2>
         
<section class="preview-episodios-mobile">
  <div>
     <!-- Episódio Anterior -->
    <% if (previousEpisode) { %>
      <div class="o-anime-popular-index o-anime-popular-index2">
      <div class=" capa-do-anime-popular-index-episodio">
      <a href="/episodio/<%= previousEpisode.id %>">
        <img src="<%= previousEpisode.image %>" alt="Episódio Anterior">
        <h4>Episódio <%= previousEpisode.numero_episodio %></h4>
      </a>
    </div>
  </div>
  <% } %>
  </div>

<div>
            <!-- Episódio Atual -->
            <div class="o-anime-popular-index o-anime-popular-index2">
              <div class="capa-do-anime-popular-index-episodio">
                <img src="<%= episodio.image %>" alt="Episódio Atual">
                <h4>Episódio <%= episodio.numero_episodio %></h4>
              </div>
            </div>
</div>

<div>
    <!-- Próximo Episódio -->
    <% if (nextEpisode) { %>
      <div class="o-anime-popular-index o-anime-popular-index2">
      <div class="capa-do-anime-popular-index-episodio">
      <a href="/episodio/<%= nextEpisode.id %>">
        <img src="<%= nextEpisode.image %>" alt="Próximo Episódio">
        <h4>Episódio <%= nextEpisode.numero_episodio %></h4>
      </a>
    </div>
  </div>
    
  <% } %>
</div>
</section>


          </div>

        </section>

        <div class="icones-episodios-anter-prox-episodio-selecionado">
            <ul>
                <a href="#">
                    <li class="adicionar-a-lista1">
                        <img src="/img/icone-favorito.png" alt="">
                        <h4>Favorito</h4>
                    </li>
                </a>
                <% if (previousEpisode) { %>
                <a href="/episodio/<%= previousEpisode.id %>">
                    <li>
                    <img src="/img/icone-seta-direita2.png" alt="">
                    <h4>Episódio Anterior</h4>
                    </li>
                </a>
                <% } %>


                <% if (locals.anime) { %>
                  <!-- Se apenas anime está presente -->
                  <a href="/anime/<%= anime.id %>">
                    <li>
                      <img src="/img/icone-lista-anime2.png" alt="">
                      <h4>Lista de Episódios </h4>
                    </li>
                  </a>
                <% } %>
                
                <% if (locals.detailsFilme) { %>
                  <!-- Se apenas detailsFilme está presente -->
                  <a href="/filme/<%= detailsFilme.id %>">
                    <li>
                      <img src="/img/icone-lista-anime2.png" alt="">
                      <h4>Lista de Episódios </h4>
                    </li>
                  </a>
                <% } %>
                
                <% if (locals.detailsDorama) { %>
                  <!-- Se apenas detailsDorama está presente -->
                  <a href="/dorama/<%= detailsDorama.id %>">
                    <li>
                      <img src="/img/icone-lista-anime2.png" alt="">
                      <h4>Lista de Episódios </h4>
                    </li>
                  </a>
                <% } %>


                
                  
                
  
                <% if (nextEpisode) { %>
                <a href="/episodio/<%= nextEpisode.id %>">
                    <li class="proximo-episodio-episodio-selecionado">
                    <h4>Próximo Episódio</h4>
                    <img src="/img/icone-seta-esquerda2.png" alt="">
                    </li>
                </a>
                <% } %>

                <a href="#">
                    <li class="adicionar-a-lista2">
                        <img src="/img/icone-favorito.png" alt="">
                        <h4>Favorito</h4>
                    </li>
                </a>
                <a href="#">
                    <li class="erro-reportar">
                        <img src="/img/icone-reportar-erro.png" alt="">
                        <h4>REPORTAR</h4>
                    </li>
                </a>

            </ul>
        </div>

        <div class="texto-assistir-anime-online-episodio-selecionado">
            <h3>Assistir <%= episodio.nome %>: Episodio <%= episodio.numero_episodio%> - Online Gratis, Assistir <%= episodio.nome %>: Episodio <%= episodio.numero_episodio %> -
             Online Legendado, Assistir <%= episodio.nome %>: Episodio <%= episodio.numero_episodio%> - Online em HD
            </h3>
        </div>

        <div class="linha-index"></div>
        <div class="espaco-episodio-selecionado"></div>


        <div class="formulario-envio-de-pedido-pedidosanimes comentarios-do-episodio">
          <section class="section-comentarios">
            <div class="">
              <ul>
                <li class="numero-da-tempora2-pagina-anime numero-da-tempora2-pagina-anime2">COMENTARIOS</li>
              </ul>
              <ul class="quantidade-comentarios">
                <li><%= quantidadeComentarios %> comentários </li>

                <div class="filtros-internos">
                    <img src="/img/icone-organizar-cimaebaixo.png" alt="" />
                    <li id="filtroOrganizar">Organizar</li>
                    <img src="/img/icone-seta-baixo.png" class="seta-baixo" alt="" />
                    <div class="filtro-opcoes-container-organizar">
                      <a href="/episodio/<%= episodio.id %>/antigo"><div id="antigo" class="filtro-opcao-organizar filtro-opcao" data-tipo="Antigo">Antigo</div></a>
                      <a href="/episodio/<%= episodio.id %>/recente"><div id="recentes" class="filtro-opcao-organizar filtro-opcao" data-tipo="Recentes">Recentes</div></a>
                    </div>
                    <form id="filtroForm-organizar" action="/episodio/<%= episodio.id %>" method="GET">
                      <input type="hidden" name="tipo" id="tipoSelecionado" value="">
                      <input type="hidden" name="ordenacao" id="ordenacaoSelecionada" value="">
                    </form>
                  </div>
              </ul>


              

              
              
        
              <script>
                $(document).ready(function () {
                  $("#filtroOrganizar").click(function () {
                    $(".filtro-opcoes-container-organizar").toggle();
                  });
              
                  $(".filtro-opcao-organizar").click(function () {
                    const tipoSelecionado = $(this).data("tipo");
                    $("#ordenacaoSelecionada").val(tipoSelecionado); // Use "ordenacaoSelecionada" em vez de "tipoSelecionado"
              
                    // Submeta o formulário para acionar a filtragem
                    $("#filtroForm-organizar").submit();
                  });
                });

                
                // Clique no link "Antigo"
                $("#antigo").click(function () {
                    $("#ordenacaoSelecionada").val("Antigo");
                    $("#filtroForm-organizar").submit();
                });

                // Clique no link "Recente"
                $("#recentes").click(function () {
                    $("#ordenacaoSelecionada").val("Recentes");
                    $("#filtroForm-organizar").submit();
                });
              </script>
              
              <div class="linha-index"></div>

            </div>
            <form class="form-comentarios" action="/episodio/<%= episodio.id %>/comment" method="post">

              <textarea name="comentario" id="comentario" placeholder="Seu Comentário..." required></textarea>
              <div>
                <input type="text" name="usuario" id="usuario" placeholder="Usuario" required>
              <input type="email" name="email" id="email" placeholder="E-mail" required>
              </div>
            
            
              <button type="submit">Enviar Comentário</button>
            </form>
            <div id="comentarios-section">
              <% if (comentarios.length > 0) { %>
                <% for (let comment of comentarios.slice(0, 18)) { %>
                    <div class="comentarios-usuarios">
                        <div class="img-usuario-inf">
                            <img src="/img/icone-foto-perfil.jpg" alt="">
                            <div>
                                <h3> <%= comment.usuario %></h3>
                                <h4> <%= comment.comentario %></h4>
                            </div>
                        </div>
                        <ul class="like-deslike-respond-comentarios">
                          <li class="icone-gostei-pagina-anime-coment">
                            <img src="/img/icone-gostei.png" alt="Gostei" class="like-button" data-comment-id="<%= comment.id %>">
                            <p><span id="likesCountComent<%= comment.id %>"><%= comment.likescomentarios %></span></p>
                          </li>
                          <li class="icone-gostei-pagina-anime-coment">
                            <img src="/img/icone-desgostei.png" alt="Não Gostei" class="dislike-button" data-comment-id="<%= comment.id %>">
                            <p><span id="dislikesCountComent<%= comment.id %>"><%= comment.dislikescomentarios %></span></p>
                          </li>
                            <li><h4>Responder</h4></li>
                            <li><h4>Editar</h4></li>
                        </ul>
                        <div>
                            <form action="/episodio/<%= episodio.id %>/comment/<%= comment.id %>?_method=DELETE" method="post" class="delete-comment-form">
                              <button type="button" class="delete-comment-button" data-comment-id="<%= comment.id %>">Excluir</button>
                            </form>
                          </div>
                    </div>

                  <% } %>

              <% } %>
            </div>
          </section>
            
          <script>
            document.addEventListener("DOMContentLoaded", function() {
              // Adicione um event listener para todas as imagens "Gostei" e "Não Gostei"
              const likeImages = document.querySelectorAll(".like-button");
              const dislikeImages = document.querySelectorAll(".dislike-button");
            
              likeImages.forEach(image => {
                image.addEventListener("click", async () => {
                  const commentId = image.getAttribute("data-comment-id");
                  const response = await fetch(`/episodio/<%= episodio.id %>/comment/${commentId}/like`, { method: "POST" });
            
                  if (response.ok) {
                    const data = await response.json();
                    const likesCountComent = document.getElementById(`likesCountComent${commentId}`);
                    likesCountComent.textContent = data.likes;
                  }
                });
              });
            
              dislikeImages.forEach(image => {
                image.addEventListener("click", async () => {
                  const commentId = image.getAttribute("data-comment-id");
                  const response = await fetch(`/episodio/<%= episodio.id %>/comment/${commentId}/dislike`, { method: "POST" });
            
                  if (response.ok) {
                    const data = await response.json();
                    const dislikesCountComent = document.getElementById(`dislikesCountComent${commentId}`);
                    dislikesCountComent.textContent = data.dislikes;
                  }
                });
              });
            });
            </script>
            
              
            <script>
    
    // Função para adicionar eventos de clique aos botões de exclusão
    document.querySelectorAll(".delete-comment-button").forEach(button => {
      button.addEventListener("click", () => {
        const commentId = button.getAttribute("data-comment-id");
        const confirmation = confirm("Tem certeza de que deseja excluir este comentário?");
    
        if (confirmation) {
          excluirComentario(commentId);
        }
      });
    });
    
    // Função para excluir um comentário
    async function excluirComentario(commentId) {
      try {
        const response = await fetch(`/episodio/<%= episodio.id %>/comment/${commentId}?_method=DELETE`, {
          method: "POST",
        });
    
        if (response.ok) {
          const data = await response.json();
          atualizarComentarios(data.comentarios);
        } else {
          console.error("Erro ao excluir comentário");
        }
      } catch (error) {
        console.error(error);
      }
    }
// Função para atualizar os comentários na página
function atualizarComentarios(comentarios) {

const comentariosSection = document.getElementById("comentarios-section");
comentariosSection.innerHTML = ""; // Limpa os comentários existentes

for (const comentario of comentarios) {
        const div = document.createElement("div");
        div.classList.add("capa-onepiece-index");
        div.innerHTML = `
          <h4>${comentario.usuario}</h4>
          <h4>${comentario.comentario}</h4>
        `;
    
        const deleteForm = document.createElement("form");
        deleteForm.action = `/episodio/<%= episodio.id %>/comment/${comentario.id}?_method=DELETE`;
        deleteForm.method = "post";
        deleteForm.innerHTML = `
          <button type="button" class="delete-comment-button" data-comment-id="${comentario.id}">Excluir</button>
        `;
    
        deleteForm.addEventListener("click", () => {
          const confirmation = confirm("Tem certeza de que deseja excluir este comentário?");
          if (confirmation) {
            excluirComentario(comentario.id);
          }
        });
    
        comentariosSection.appendChild(div);
        comentariosSection.appendChild(deleteForm);
      }
    }
    
    // Evento de envio do formulário de comentários
    document.getElementById("comentario-form").addEventListener("submit", async (e) => {
      e.preventDefault();
    
      const formData = new FormData(e.target);
      const detailsFilmesId = window.location.pathname.split("/")[2]; // Obtém o ID do anime da URL
      const detailsDoramasId = window.location.pathname.split("/")[2]; // Obtém o ID do anime da URL
    
      try {
        const response = await fetch(`/episodio/${episodio}/comment`, {
          method: "POST",
          body: formData,
        });
    
        if (response.ok) {
          const data = await response.json();
          atualizarComentarios(data.comentarios);
        }
      } catch (error) {
        console.error(error);
        // Lida com erros aqui, como mostrar uma mensagem de erro ao usuário
      }
    });
    
    
              </script>
    
    
        </div>
    
    </div>


    <div class="lado-direito-do-site-index">

        <div class="linha-lateral-direita-index2"> </div>
        <div class="linha-lateral-direita-index">

            <section class="sessao-1-lado-direiro-index">
            <div class="animes-populares-index">
                <h2>Lista de Episodios</h2>
                <!-- Episódio Anterior -->
                <% if (previousEpisode) { %>
                    <div class="o-anime-popular-index o-anime-popular-index2">
                    <div class=" capa-do-anime-popular-index-episodio">
                    <a href="/episodio/<%= previousEpisode.id %>">
                      <img src="<%= previousEpisode.image %>" alt="Episódio Anterior">
                      <h4>Episódio <%= previousEpisode.numero_episodio %></h4>
                    </a>
                  </div>
                </div>
                <% } %>
              
                <!-- Episódio Atual -->
                <div class="o-anime-popular-index o-anime-popular-index2">
                <div class="capa-do-anime-popular-index-episodio">
                  <img src="<%= episodio.image %>" alt="Episódio Atual">
                  <h4>Episódio <%= episodio.numero_episodio %></h4>
                </div>
            </div>
              
                <!-- Próximo Episódio -->
                <% if (nextEpisode) { %>
                    <div class="o-anime-popular-index o-anime-popular-index2">
                    <div class="capa-do-anime-popular-index-episodio">
                    <a href="/episodio/<%= nextEpisode.id %>">
                      <img src="<%= nextEpisode.image %>" alt="Próximo Episódio">
                      <h4>Episódio <%= nextEpisode.numero_episodio %></h4>
                    </a>
                  </div>
                </div>
                  
                <% } %>
                </div>

              </section>
    </div>



    <div class="lado-direito-do-site-index">

        <div class="linha-lateral-direita-index2"> </div>
        <div class="linha-lateral-direita-index">
            <!-- Dentro de sua visualização (sua_pagina.ejs) -->
<section class="sessao-1-lado-direiro-index">
  <div class="animes-populares-index">
    <h2>ANIMES POPULARES</h2>
    <% animesPopulares.forEach(anime => { %>
      <a href="/anime/<%= anime.id %>">
        <div class="o-anime-popular-index">
          <div class="capa-do-anime-popular-index">
            <img src="<%= anime.capa %>" alt="<%= anime.nome %>">
          </div>
          <div class="o-anime-popular-index-lado-direiro">
            <div>
              <h3><%= anime.nome.substring(0, 15) %></h3>
              <div class="nota-do-anime-index">
                       <h4><%= anime.percentage %></h4>
                      <img src="/img/nota.png" alt="">
              </div>
            </div>
          </div>
        </div>
      </a>
    <% }); %>
  </div>
</section>

        
            <section class="sessao-1-lado-direiro-index">
                <div class="animes-populares-index mangas-populares-index">
                    <h2>MANGAS POPULARES</h2>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href="">
                    <div class="o-anime-popular-index">
                        <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                        </div>
                        <div class="o-anime-popular-index-lado-direiro">
                            <div>
                                <h4>NORAGAMI</h4>
                                <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                            </div>
                        </div>
                        
                    </div>
                </a>
                
                </div>
            </section>

            <section class="sessao-1-lado-direiro-index">
                <div class="animes-populares-index mangas-populares-index">
                    <h2>NOTICÍAS DO BLOG</h2>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href=""><div class="o-anime-popular-index">
                    <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                    </div>
                    <div class="o-anime-popular-index-lado-direiro">
                        <div>
                            <h4>NORAGAMI</h4>
                            <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                        </div>
                    </div>
                </div>
                </a>
                <a href="">
                    <div class="o-anime-popular-index">
                        <div class="capa-do-anime-popular-index"> <img src="/img/capa-noragami.jpg" alt=""> 
                        </div>
                        <div class="o-anime-popular-index-lado-direiro">
                            <div>
                                <h4>NORAGAMI</h4>
                                <div class="nota-do-anime-index"><img src="/img/nota.png" alt=""></div>
                            </div>
                        </div>
                        
                    </div>
                </a>
                
                </div>
            </section>
    </div>

</section>
<% } %>


<%- include("./partials/footer") %> 
